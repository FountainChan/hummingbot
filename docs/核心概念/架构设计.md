# Hummingbot 架构设计

## 整体架构

Hummingbot 采用分层架构设计，从下往上分为：

```
┌─────────────────────────────┐
│    用户界面层 (Client)       │  CLI / 用户交互
├─────────────────────────────┤
│    策略执行层 (Strategy)     │  策略逻辑与协调
├─────────────────────────────┤
│  控制器+执行器层             │  交易控制与订单执行
├─────────────────────────────┤
│    交易所连接器层 (Connector)│  交易所 API 交互
├─────────────────────────────┤
│    核心框架层 (Core)        │  事件系统、数据类型等
```

## 核心组件

### 1. 策略系统（Strategy）

#### ScriptStrategyBase
- 最简化的策略基类
- 用于快速开发简单策略脚本
- 提供基本的市场访问和订单管理

#### StrategyV2Base
- 现代策略框架的基类
- 支持多个控制器和执行器
- 提供性能跟踪和风险管理
- 支持动态控制器配置更新

**特点**：
```python
class StrategyV2Base(StrategyPyBase):
    def __init__(self, connectors, config):
        # 初始化多个控制器
        self.controllers = {}
        # 初始化执行器编排器
        self.executor_orchestrator = ExecutorOrchestrator()
```

### 2. 控制器系统（Controllers）

控制器是独立的算法模块，负责生成交易信号和管理执行器。

#### 类别

**方向型交易控制器**（directional_trading/）
- Bollinger Bands V1/V2
- SuperTrend V1
- MACD + Bollinger Bands
- D-Man V3
- RSI 方向策略

**做市商控制器**（market_making/）
- 简单做市（PMM Simple）
- 动态做市（PMM Dynamic）
- DMan Maker V2

**通用控制器**（generic/）
- 套利控制器
- 对冲资产
- 多网格
- 网格交易

#### 控制器的生命周期

```
创建 → 启动 → 运行 → 信号生成 → 创建执行器 → 停止
```

#### 控制器配置

所有控制器均继承自 `DirectionalTradingControllerConfigBase` 或 `ControllerConfigBase`：

```python
class BollingerV1ControllerConfig(DirectionalTradingControllerConfigBase):
    controller_name: str = "bollinger_v1"
    candles_config: List[CandlesConfig] = []
    candles_connector: str  # K线数据源
    candles_trading_pair: str
    interval: str  # 时间间隔
    bb_length: int  # Bollinger Bands 周期
    bb_std: float  # 标准差倍数
    bb_long_threshold: float  # 做多阈值
    bb_short_threshold: float  # 做空阈值
```

### 3. 执行器系统（Executors）

执行器负责实际执行交易，处理订单的放置、监控和平仓。

#### 执行器类型

| 执行器 | 功能 | 用途 |
|--------|------|------|
| **OrderExecutor** | 单笔订单执行 | 简单的买卖操作 |
| **PositionExecutor** | 持仓管理 | 管理长期持仓 |
| **GridExecutor** | 网格交易 | 高频小额交易 |
| **TwapExecutor** | 时间加权平均价格 | 大额订单分批执行 |
| **DCAExecutor** | 定额成本平均 | 定期定额购买 |
| **XemmExecutor** | 跨交所做市 | 两个交所的套利 |
| **ArbitrageExecutor** | 套利执行 | 交易对套利 |

#### 执行器配置示例

```python
class OrderExecutorConfig(ExecutorConfigBase):
    execute_side: TradeType  # BUY 或 SELL
    leverage: Decimal  # 杠杆倍数
    amount: Decimal  # 订单数量
    order_optimization_enabled: bool  # 是否优化价格
    order_optimization_depth: int  # 优化深度
```

#### 执行器生命周期

```
创建 → 初始化 → 执行订单 → 监控 → 平仓 → 完成
```

### 4. 交易所连接器（Connectors）

负责与交易所 API 的交互。

#### 连接器分类

- **现货交易所**（exchange/）：币安、Coinbase、Kraken 等
- **衍生品交易所**（derivative/）：Binance Futures、Bybit 等
- **网关连接器**（gateway/）：以太坊、Solana 等 DEX
- **其他**（other/）：Parrot（纸 paper 交易）

#### 基类：ConnectorBase

```python
class ConnectorBase:
    def buy(self, trading_pair, quantity, order_type, price)
    def sell(self, trading_pair, quantity, order_type, price)
    def cancel_order(self, order_id)
    def get_order_book(self, trading_pair)
    def get_trading_fees(self, trading_pair)
```

### 5. 核心框架（Core）

#### 事件系统
- `BuySellEvent`：订单创建事件
- `OrderFilledEvent`：订单成交事件
- `OrderCanceledEvent`：订单取消事件
- `DepthBidsAskEvent`：订单簿更新事件

#### 数据类型
- `LimitOrder`：限价订单
- `MarketOrder`：市价订单
- `OrderBook`：订单簿
- `Trade`：交易记录

#### 时钟系统
- 提供统一的时间同步
- 支持回测和实盘一致的时间

## 工作流程示例：StrategyV2 + 控制器 + 执行器

```
┌─────────────────────────┐
│   StrategyV2Base        │  主策略
│  (性能监控、风险管理)    │
└────────────┬────────────┘
             │ 管理多个
             ├───────────────────┐
             │                   │
    ┌────────▼──────┐    ┌──────▼────────┐
    │ Controller 1   │    │ Controller 2   │
    │ (Bollinger V1) │    │ (SuperTrend V1)│
    └────────┬──────┘    └──────┬────────┘
             │                   │
    ┌────────▼──────┐    ┌──────▼────────┐
    │ Executor 1     │    │ Executor 3     │
    │ (Order Exec.)  │    │ (Grid Exec.)   │
    └────────┬───────┘    └──────┬────────┘
             │                   │
    ┌────────▼────────────────────┴──────┐
    │   ExecutorOrchestrator              │
    │   (订单协调与执行)                   │
    └────────┬───────────────────────────┘
             │
    ┌────────▼──────────────────────┐
    │ Connector (币安、Coinbase 等)   │
    │ (交易所 API 调用)              │
    └───────────────────────────────┘
```

## 数据流向

### 1. 行情数据流向

```
交易所 API
    ↓
Connector (获取订单簿、蜡烛线)
    ↓
CandlesFeed (K线聚合)
    ↓
Controller (技术指标计算)
    ↓
交易信号生成
```

### 2. 订单执行流向

```
Controller (生成交易信号)
    ↓
Executor (创建 CreateExecutorAction)
    ↓
ExecutorOrchestrator (协调执行)
    ↓
Connector (发送订单到交易所)
    ↓
市场执行
    ↓
回调事件更新状态
```

## 主要特性

### 1. 模块化设计
- 控制器、执行器独立开发
- 可以组合使用不同的组件
- 便于测试和维护

### 2. 异步架构
- 基于 asyncio 的异步设计
- 高效的并发处理
- 支持多市场并行交易

### 3. 事件驱动
- 订单状态变化触发事件
- 行情更新推送事件
- 解耦各个组件

### 4. 性能监控
- 实时 PnL 计算
- 风险指标跟踪
- 详细的性能报告

## API 阈值控制

```python
from hummingbot.core.api_throttler.async_throttler import AsyncThrottler

# 防止超过 API 调用限制
throttler = AsyncThrottler(rate_limits=[
    RateLimit(1, 1),  # 每 1 秒 1 个请求
])
```

## 日志系统

```python
from hummingbot.logger import HummingbotLogger

logger = HummingbotLogger(__name__)
logger.info("策略启动")
logger.warning("警告信息")
logger.error("错误信息")
```

## 下一步

- 查看[策略开发指南](../策略开发/新策略开发指南.md)了解如何开发新策略
- 了解[执行器系统](../执行器/执行器系统.md)的详细信息
- 学习[控制器开发](../控制器/控制器系统.md)方法
