# 策略清单（项目内）

本文档列出仓库中主要的策略实现与示例脚本，包含文件位置、如何运行（概览）与算法/原理要点。

注意：大多数策略通过 Hummingbot CLI 或脚本接口运行。脚本示例可用 `script start <path>` 在客户端中加载；内置策略通常通过客户端的 `start` 命令并加载对应配置文件（见 `conf/`）。

---

## 核心策略（hummingbot/strategy）

- **Pure Market Making（纯做市）**
  - 位置：`hummingbot/strategy/pure_market_making/`
  - 入口：`hummingbot/strategy/pure_market_making/start.py`
  - 运行：在 Hummingbot CLI 中选择或加载 `pure_market_making` 的配置并 `start`；也可用相应 conf 文件启动。
  - 原理：在买卖两侧同时挂单以赚取点差，包含库存（inventory）管理与移动价带（moving price band）以控制中性风险。

- **Avellaneda Market Making（Avellaneda 做市）**
  - 位置：`hummingbot/strategy/avellaneda_market_making/`
  - 入口：`start.py`（同目录）
  - 运行：通过客户端加载 `avellaneda_market_making` 配置并 `start`。
  - 原理：基于 Avellaneda & Stoikov 模型动态计算买卖价差，目标为在给定风险厌恶参数下优化收益-风险权衡。

- **Perpetual Market Making（衍生品做市）**
  - 位置：`hummingbot/strategy/perpetual_market_making/`
  - 入口：`perpetual_market_making.py`, `start.py`
  - 运行：加载 `perpetual_market_making` 配置并 `start`。
  - 原理：针对永续合约市场的做市逻辑，考虑资金费率、仓位限制与保证金规则。

- **AMM Arbitrage（AMM 套利） / amm_arb**
  - 位置：`hummingbot/strategy/amm_arb/`
  - 入口：`amm_arb.py`, `start.py`
  - 运行：加载 `amm_arb` 配置并 `start`。
  - 原理：在 AMM（如 Uniswap）与中心化/其他流动性源间捕捉价格差并执行套利交易。

- **Cross-Exchange Market Making / Cross-Exchange Mining**
  - 位置：`hummingbot/strategy/cross_exchange_market_making/`，`hummingbot/strategy/cross_exchange_mining/`
  - 入口：各自目录下的 `start.py` 与策略文件
  - 运行：加载对应策略配置并 `start`。
  - 原理：跨交易所分配挂单或挖矿（提供流动性获取激励），通常涉及资金与订单同步逻辑。

- **Liquidity Mining**
  - 位置：`hummingbot/strategy/liquidity_mining/`
  - 入口：`liquidity_mining.py`, `start.py`
  - 运行：加载 `liquidity_mining` 配置并 `start`。
  - 原理：为特定市场提供流动性并追踪激励（例如返佣/补贴），包含收益统计与风险控制。

- **Hedge（对冲）**
  - 位置：`hummingbot/strategy/hedge/`
  - 入口：`hedge.py`, `start.py`
  - 运行：加载 `hedge` 配置并 `start`。
  - 原理：实现不同市场或资产间头寸对冲，减少敞口与市场风险。

---

## Strategy V2（模块化控制器/执行器架构）

项目包含 `strategy_v2` 框架，分层为 Controllers（信号生成）与 Executors（下单执行）。常见实现位于：

- 位置：`hummingbot/strategy_v2/controllers/`、`hummingbot/strategy_v2/executors/`
- 运行：通过在脚本或 StrategyV2 主体中实例化 Controllers 与 Executors（示例脚本：`scripts/v2_with_controllers.py`、`scripts/v2_twap_multiple_pairs.py` 等）。
- 原理：把策略拆分为生成信号（Controller）和执行下单（Executor），便于组合与测试。

示例组件：
- `twap_executor`（定时拆单执行）: `hummingbot/strategy_v2/executors/twap_executor/`
- `grid_executor`：网格执行器：`hummingbot/strategy_v2/executors/grid_executor/`
- `dca_executor`：均摊买入执行器：`hummingbot/strategy_v2/executors/dca_executor/`

示例脚本（V2）：
- `scripts/v2_with_controllers.py` — 演示如何在 StrategyV2 架构下组合控制器与执行器。
- `scripts/v2_directional_rsi.py`、`scripts/v2_funding_rate_arb.py`、`scripts/v2_twap_multiple_pairs.py` — V2 风格策略示例。

---

## CLI-脚本示例（`scripts/`）

仓库包含大量脚本示例，方便快速测试或作为策略模板。

- `scripts/simple_pmm.py` / `scripts/basic/simple_order_example.py` / `scripts/simple_vwap.py`
  - 位置：`scripts/` 与 `scripts/basic/`
  - 运行：在 Hummingbot CLI 中运行 `script start scripts/simple_pmm.py` 或通过 `tools/run_synthetic_backtest.py` 生成示例数据。
  - 原理：简化版的做市 / VWAP 下单示例，适合演示客户端脚本接口。

- `scripts/utility/backtest_mm_example.py`
  - 位置：`scripts/utility/backtest_mm_example.py`
  - 运行：作为脚本运行（`script start scripts/utility/backtest_mm_example.py`）或直接在 Python 环境中以 `PYTHONPATH` 调用脚本（需安装包依赖）；脚本会把回测结果导出为 CSV。
  - 原理：基于历史 OHLCV 蜡烛模拟简化做市成交逻辑并输出统计结果，便于回测快速验证。

- 社区示例（`scripts/community/`）
  - 包含：`directional_strategy_trend_follower.py`, `directional_strategy_macd_bb.py`, `simple_rsi_no_config.py`, `fixed_grid.py`, `triangular_arbitrage.py` 等。
  - 运行：`script start scripts/community/<file>.py`
  - 原理：社区贡献的多种策略模板（趋势跟随、指标组合、网格、三角套利等），适合参考与改造。

---

## 如何运行策略（概览）

1. 启动 Hummingbot 客户端（交互式）：
   ```bash
   # 在开发环境或虚拟环境中
   python -m hummingbot
   # 或使用仓库的 bin 脚本（视环境而定）
   # bin/hummingbot.py
   ```

2. 在客户端中：
   - 运行脚本：`script start <relative-path-to-script>`，例如：
     ```text
     script start scripts/utility/backtest_mm_example.py
     ```
   - 启动内置策略：使用 `start` 命令并加载相应的配置（通常在 `conf/` 下有模板），或在首次运行时按提示创建配置并 `start`。

3. 非交互方式（示例）：
   - 使用我们添加的合成回测工具：
     ```bash
     /workspaces/hummingbot/.venv/bin/python tools/run_synthetic_backtest.py --out data/synth_backtest.csv --plot
     ```

---


## 建议与下一步

- 我可以为每个策略编写更详细的运行示例（示例 conf、必需参数说明、典型风险参数），以及把每个策略的配置模板拷贝到 `docs/策略开发/` 作为子文档。请确认是否需要对某些策略（例如 `avellaneda_market_making`、`pure_market_making`、或 V2 控制器组合）进行深度文档化。

---

文件生成：`docs/策略开发/策略清单.md`。

---

**附加：策略选择决策矩阵（针对 BTC/USDT 永续合约）**

目的：为其他 AI agent 提供清晰的规则集——在检测到 BTC/USDT 永续合约行情“发生变化”时，能够根据定量触发条件自动选择最合适的策略与风险参数。

1) 术语与信号定义
- 实现时请保证输入数据流包含：最新 OHLCV（1m / 5m / 1h）、逐笔或深度快照（order book top N）、资金费率（funding_rate）、未平仓合约量（open_interest）、交易所间基差（index_price vs mark_price）、以及指标：ATR、短/长均线（SMA短=5/20，长=50/200）、VWAP、成交量加速度（volatility surge）。
- 关键信号（可并行评估）：
  - 波动率（Volatility）：用 ATR 或历史对数收益标准差（例如 30m）衡量。
  - 趋势强度（Trend）：短期均线与长期均线差距与斜率（MA5 - MA50，或 EMA斜率）
  - 市场偏斜（Skew / Orderbook Imbalance）：买卖挂单量比（bid_volume / ask_volume）或深度加权价差
  - 资金费率异常（Funding）：当前 funding_rate 与历史均值的偏离
  - 流动性稀缺（Liquidity）：最佳买卖价差（best_ask - best_bid）/ mid_price 大于阈值，或 depth 在关键档位显著下降

2) 行情场景、检测条件与策略映射（简洁矩阵）

 - 场景 A：低波动、横盘（Range）
   - 检测：ATR(30m) < low_vol_threshold，MA5 与 MA50 交叉频率低，funding_rate 正常
   - 推荐策略：`Pure Market Making` / `Avellaneda` / `Liquidity Mining`
   - 参数建议：tight spread（bid/ask spread 小），较小单笔量，开启库存中性机制（inventory_target≈0），较高挂单深度（多档）
   - 风控：max_position 小，监控滑点与挂单被吃空的速率

 - 场景 B：明确单边趋势（强上升或下降）
   - 检测：MA5 >> MA50 且短期成交量放大；或 EMA 斜率持续正/负，ATR 中等或上升
   - 推荐策略：`Directional / Trend-Following`（V2 控制器）或 `TWAP/VWAP`（分批执行）
   - 参数建议：允许持仓（directional），加仓规则基于突破确认；止损/止盈严格（例如 1-2% 止损），减小做市暴露
   - 风控：资金费率敏感时限制杠杆；若资金费率极端反转转为对冲/平仓

 - 场景 C：波动率突增（Volatility Spike）
   - 检测：ATR(5m) 或 1m 历史波动显著上升（> historical_mean + k * std），orderbook 深度骤降
   - 推荐策略：暂停纯做市（撤单）、启用 `Hedge` 或 `Trend/Mean-Reversion` 的快速短线策略，或完全退场
   - 参数建议：立即收缩/撤销被动挂单，reduce position to hedge，临时禁用自动下单若流动性不足
   - 风控：触发急速平仓 / 限速下单，启用最大滑点保护

 - 场景 D：资金费率显著偏离（Funding Arbitrage）
   - 检测：funding_rate 与历史均值差距大（例如 > 2σ），或不同交易所 funding 差异
   - 推荐策略：`Funding Rate Arbitrage`（做多/做空资金方向相反的仓位）或 `Perpetual Market Making` 与对冲组合
   - 参数建议：使用对冲保证金配置，控制杠杆与持仓限额，分段入场以降低资金费率变动风险
   - 风控：保证金監控与强平预警，设置 funding_rate 风险阈值自动减仓

 - 场景 E：跨交易所/AMM 存在套利机会
   - 检测：spot 与 perp 之间的基差显著、或集中市场与 AMM 价格差持续
   - 推荐策略：`Cross-Exchange Arbitrage` / `AMM Arbitrage`
   - 参数建议：优先小仓位快速执行、并行下单与确认机制、考虑手续费与资金成本
   - 风控：延迟/滑点容忍度、订单实效性验证、并发失败回滚

3) 策略优先级与自動選擇邏輯（伪代码）

基本原则：先做安全性评估（流动性/极端波动/异常 funding），若危险則優先風控（撤單/對沖/退場）；否則依據收益-風險模型選擇策略。

pseudocode:

```
if liquidity_drought or volatility_spike:
  action = "pause_market_making; hedge_or_exit"
elif trending_up or trending_down:
  action = "directional_strategy_or_twap"
elif funding_anomaly:
  action = "funding_arbitrage_or_hedge"
elif cross_exchange_arb_opportunity:
  action = "cross_exchange_arb"
else:
  action = "market_making_or_avellaneda"
```

4) 每个策略的触发信号与关键参数（摘要）
 - `Pure Market Making`：
   - 触发信号：低波动、深度充足、funding 正常
   - 关键参数：`spread_bps`（建议 1–20 bps 根据流动性）、`order_amount`、`inventory_target`、`order_refresh_time`
   - 停止条件：连续亏损超阈、资金费率极端、流动性不足

 - `Avellaneda Market Making`：
   - 触发信号：波动率中低、希望在风险-收益上优雅平衡
   - 关键参数：`risk_aversion`、`reservation_price_window`、`order_size`
   - 停止条件：模型参数失效（历史波动突然变化）

 - `Perpetual Market Making`：
   - 触发信号：永续合约市场、可获取 funding 与保证金信息
   - 关键参数：`leverage_limit`、`max_position`、`funding_hedge_enabled`
   - 停止条件：保证金率接近清算、funding 逆转剧烈

 - `Directional / Trend-Following`（V2 控制器）：
   - 触发信号：均线突破、成交量放大、趋势确认窗口
   - 关键参数：`entry_threshold`、`stop_loss_pct`、`take_profit_pct`、`pyramiding_limit`

 - `Grid`：
   - 触发信号：明显区间震荡、波动可预测
   - 关键参数：`grid_size_steps`、`upper_bound`、`lower_bound`、`order_amount`

 - `TWAP/VWAP`：
   - 触发信号：需要分批执行大额单以减少滑点（被动执行）
   - 关键参数：`interval_seconds`、`slice_size`

 - `Hedge`：
   - 触发信号：头寸方向暴露、对冲成本可控
   - 关键参数：`hedge_ratio`、`hedge_instrument`

5) 监控与回退（必备）
 - 必须实时监控：`PnL`、`未实现盈亏`、`保证金率`、`挂单被吃速率`、`资金费率`、`订单失败率`。
 - 回退策略示例：
   - 若 1 分钟内挂单被吃速率 > X 且滑点 > Y → 自动撤单并转入 `Hedge` 模式
   - 若连续 N 个周期净损失 > Z → 降低仓位比例或暂停交易
   - 若资金费率触发阈值 → 分步减仓或对冲仓位

6) 样例：简单规则集（可直接实现于 agent）
 - 检测指标：ATR30m, MA5-MA50 差值, orderbook_imbalance(10), funding_rate_zscore

规则：
 - 如果 ATR30m > ATR30m_mean + 2 * ATR30m_std 且 depth_at_top10 < depth_threshold → 触发场景 C（撤单/对冲）
 - 如果 MA5 - MA50 > trend_threshold 且 volume_increase > vol_thresh → 触发趋势策略（Direction）
 - 如果 funding_rate_zscore > 2 且 basis_perp_spot > basis_thresh → 触发 Funding Arbitrage
 - 否则，在 low_vol 阈内运行 `Avellaneda` 或 `Pure Market Making`，优先 Avellaneda 当需要风险调节

7) 输出与操作接口建议（供 agent 调用）
 - 建议 agent 输出统一结构：`{scene: "trend_up", recommended_strategy: "directional_v2", confidence:0.82, params: {...}, actions: ["start directional", "reduce MM exposure"]}`
 - `params` 字段包含可直接写入 `conf/` 的关键字段（例如 `order_amount`, `spread_bps`, `max_position`）

---

如果你同意，我会把上述矩阵的每一项展开为独立的策略页面（`docs/策略开发/策略细则/<strategy>.md`），并为 `BTC/USDT 永续合约` 提供一组可直接复制到 `conf/` 的推荐配置样例。请确认是否继续，我将继续写入并提交更改。
