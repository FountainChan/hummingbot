# 新策略开发完整指南

## 概述

本指南将教你如何在 Hummingbot 中开发新的交易策略。Hummingbot 提供了两种策略开发方式：

1. **ScriptStrategyBase 方式**：快速、简单，适合简单策略
2. **StrategyV2 + Controllers 方式**：复杂、灵活，适合复杂策略

## 方式一：使用 ScriptStrategyBase（简单策略）

### 场景
- 简单的技术指标策略
- 单一控制逻辑
- 快速原型开发

### 基本结构

```python
from decimal import Decimal
from typing import Dict, Set
from pydantic import Field

from hummingbot.strategy.script_strategy_base import ScriptStrategyBase, ScriptConfigBase
from hummingbot.connector.connector_base import ConnectorBase


class MySimpleStrategyConfig(ScriptConfigBase):
    """策略配置"""
    exchange: str = Field(default="binance")
    trading_pair: str = Field(default="BTC-USDT")
    buy_price: Decimal = Field(default=Decimal("30000"))
    sell_price: Decimal = Field(default=Decimal("40000"))


class MySimpleStrategy(ScriptStrategyBase):
    """简单价格追踪策略"""
    
    markets = {
        "binance": {"BTC-USDT"}
    }
    
    @classmethod
    def init_markets(cls, config: MySimpleStrategyConfig):
        """初始化市场/交易所"""
        return config.markets
    
    def __init__(self, connectors: Dict[str, ConnectorBase], config: MySimpleStrategyConfig):
        super().__init__(connectors, config)
        self.config = config
        self.buy_executed = False
        self.sell_executed = False
    
    def on_tick(self):
        """每秒调用一次，主要交易逻辑"""
        if not self.ready_to_trade:
            return
        
        exchange = self.connectors["binance"]
        order_book = exchange.get_order_book(self.config.trading_pair)
        current_price = order_book.get_price(False)  # 获取最新卖价
        
        # 买入逻辑
        if current_price <= self.config.buy_price and not self.buy_executed:
            self.buy_order(
                connector_name="binance",
                trading_pair=self.config.trading_pair,
                amount=Decimal("1"),
                order_type=OrderType.LIMIT,
                price=self.config.buy_price
            )
            self.buy_executed = True
        
        # 卖出逻辑
        if current_price >= self.config.sell_price and not self.sell_executed:
            self.sell_order(
                connector_name="binance",
                trading_pair=self.config.trading_pair,
                amount=Decimal("1"),
                order_type=OrderType.LIMIT,
                price=self.config.sell_price
            )
            self.sell_executed = True
    
    def on_order_created_event(self, event):
        """订单创建事件回调"""
        self.logger().info(f"订单已创建: {event}")
    
    def on_order_filled_event(self, event):
        """订单成交事件回调"""
        self.logger().info(f"订单已成交: {event}")
```

### 使用此策略

1. **保存文件**：`scripts/my_simple_strategy.py`
2. **启动**：在 Hummingbot CLI 中选择此脚本
3. **配置**：系统会根据 Field 定义提示配置参数

## 方式二：使用 StrategyV2 + Controllers（复杂策略）

### 场景
- 多市场、多交易对
- 多个独立的交易算法
- 需要动态配置更新
- 复杂的风险管理

### 整体架构

```python
StrategyV2Base          # 主策略
   ├── Controller 1     # 控制器 1（如 Bollinger）
   │   └── Executor 1   # 执行器 1（如 Order 执行）
   ├── Controller 2     # 控制器 2（如 SuperTrend）
   │   └── Executor 2   # 执行器 2（如 Grid 执行）
   └── ExecutorOrchestrator  # 执行协调器
```

### 开发步骤

#### 第一步：创建控制器配置

如果要开发新的控制器（算法），创建配置类：

```python
from typing import List, Set, Optional
from pydantic import Field, field_validator
from hummingbot.data_feed.candles_feed.data_types import CandlesConfig
from hummingbot.strategy_v2.controllers.directional_trading_controller_base import (
    DirectionalTradingControllerBase,
    DirectionalTradingControllerConfigBase,
)


class MyCustomControllerConfig(DirectionalTradingControllerConfigBase):
    """自定义控制器配置"""
    
    # 基础配置
    controller_name: str = "my_custom_controller"
    candles_config: List[CandlesConfig] = []
    
    # 交易对信息
    connector_name: str = Field(default="binance")
    trading_pair: str = Field(default="BTC-USDT")
    
    # 你的算法参数
    fast_ma_period: int = Field(default=10)
    slow_ma_period: int = Field(default=30)
    signal_threshold: float = Field(default=0.5)
    
    # 执行器参数
    order_amount: float = Field(default=1.0)
    stop_loss_pct: float = Field(default=2.0)  # 止损百分比
    take_profit_pct: float = Field(default=5.0)  # 止盈百分比
    
    @field_validator("candles_connector", mode="before")
    @classmethod
    def set_candles_connector(cls, v, validation_info):
        if v is None or v == "":
            return validation_info.data.get("connector_name")
        return v
```

#### 第二步：创建控制器实现

```python
from hummingbot.strategy_v2.controllers.directional_trading_controller_base import (
    DirectionalTradingControllerBase,
)
from hummingbot.strategy_v2.models.executor_actions import CreateExecutorAction
from hummingbot.strategy_v2.executors.order_executor.order_executor import OrderExecutor
from hummingbot.strategy_v2.executors.order_executor.data_types import OrderExecutorConfig
from hummingbot.core.event.events import TradeType
from decimal import Decimal
import pandas as pd


class MyCustomController(DirectionalTradingControllerBase):
    """自定义交易控制器"""
    
    def __init__(self, config: MyCustomControllerConfig):
        super().__init__(config)
        self.config = config
        self.fast_ma = None
        self.slow_ma = None
    
    async def control_task(self) -> None:
        """控制任务，每个更新周期执行一次"""
        # 获取蜡烛线数据
        candles = self.get_candles()
        
        if len(candles) < self.config.slow_ma_period:
            return  # 数据不足
        
        # 计算移动平均线
        closes = candles["close"].values
        self.fast_ma = pd.Series(closes).rolling(self.config.fast_ma_period).mean().iloc[-1]
        self.slow_ma = pd.Series(closes).rolling(self.config.slow_ma_period).mean().iloc[-1]
        
        current_price = candles["close"].iloc[-1]
        
        # 生成交易信号
        signal = None
        if self.fast_ma > self.slow_ma and current_price > self.fast_ma:
            signal = TradeType.BUY
        elif self.fast_ma < self.slow_ma and current_price < self.fast_ma:
            signal = TradeType.SELL
        
        # 创建执行器
        if signal:
            await self.create_executor(signal)
    
    async def create_executor(self, side: TradeType):
        """创建订单执行器"""
        executor_config = OrderExecutorConfig(
            id=f"{self.config.controller_name}_{side.name}_{self.timestamp}",
            connector_name=self.config.connector_name,
            trading_pair=self.config.trading_pair,
            execute_side=side,
            leverage=Decimal("1"),
            amount=Decimal(str(self.config.order_amount)),
            order_optimization_enabled=True,
            order_optimization_depth=1,
        )
        
        # 创建执行器动作
        action = CreateExecutorAction(
            controller_id=self.config.controller_name,
            executor_config=executor_config,
        )
        
        # 返回动作给编排器
        return action
    
    def get_candles(self):
        """获取蜡烛线数据"""
        connector = self.data_feed.connectors[self.config.candles_connector]
        return connector.get_candles(
            self.config.candles_trading_pair,
            int(self.config.interval)
        )
```

#### 第三步：创建主策略

```python
from typing import Dict, Set, Optional
from pydantic import Field
from hummingbot.strategy.strategy_v2_base import StrategyV2Base, StrategyV2ConfigBase
from hummingbot.connector.connector_base import ConnectorBase
from hummingbot.data_feed.candles_feed.data_types import CandlesConfig


class MyCustomStrategyConfig(StrategyV2ConfigBase):
    """主策略配置"""
    
    # 基础配置
    markets: Dict[str, Set[str]] = {
        "binance": {"BTC-USDT", "ETH-USDT"}
    }
    candles_config: List[CandlesConfig] = [
        CandlesConfig(
            connector="binance",
            trading_pair="BTC-USDT",
            interval="1h",
            max_records=1000
        )
    ]
    
    # 风险参数
    max_global_drawdown_quote: Optional[float] = None
    max_controller_drawdown_quote: Optional[float] = None


class MyCustomStrategy(StrategyV2Base):
    """自定义交易策略主类"""
    
    def __init__(self, connectors: Dict[str, ConnectorBase], config: MyCustomStrategyConfig):
        super().__init__(connectors, config)
        self.config = config
        
        # 初始化控制器
        controller_config = MyCustomControllerConfig(
            connector_name="binance",
            trading_pair="BTC-USDT",
        )
        self.controllers["my_controller"] = MyCustomController(controller_config)
    
    async def on_tick(self):
        """每个心跳周期执行"""
        # 这里处理中断条件、性能报告等
        super().on_tick()
        
        # 你的自定义逻辑
        self.check_global_performance()
    
    def check_global_performance(self):
        """检查全局性能"""
        global_pnl = sum([
            self.get_performance_report(controller_id).global_pnl_quote
            for controller_id in self.controllers.keys()
        ])
        
        if global_pnl < -1000:
            self.logger().warning("全局损失过大，停止策略")
            self.stop()
```

#### 第四步：创建配置文件

保存为 `conf/my_custom_strategy.yml`：

```yaml
strategy: my_custom_strategy
connector_1: binance
connector_2: null

# 币安连接器配置
binance_api_key: "your_api_key"
binance_api_secret: "your_api_secret"

# 交易对
trading_pair_1: BTC-USDT
trading_pair_2: ETH-USDT

# 控制器配置
controller_name: my_custom_controller
connector_name: binance
trading_pair: BTC-USDT
fast_ma_period: 10
slow_ma_period: 30
signal_threshold: 0.5
order_amount: 1.0
stop_loss_pct: 2.0
take_profit_pct: 5.0

# K线配置
candles_connector: binance
candles_trading_pair: BTC-USDT
candles_interval: 1h
candles_max_records: 1000
```

## 关键开发概念

### 1. 订单类型

```python
from hummingbot.core.event.events import OrderType, TradeType

OrderType.LIMIT      # 限价单
OrderType.MARKET     # 市价单

TradeType.BUY        # 做多
TradeType.SELL       # 做空
```

### 2. 技术指标计算

使用 `pandas_ta` 库：

```python
import pandas_ta as ta

# RSI 指标
rsi = ta.rsi(closes, length=14)

# MACD 指标
macd_result = ta.macd(closes, fast=12, slow=26, signal=9)

# Bollinger Bands
bb_result = ta.bbands(closes, length=20, std=2.0)
```

### 3. 异步事件处理

```python
def on_order_filled_event(self, event):
    """订单成交事件"""
    self.logger().info(f"订单成交: 数量={event.amount}, 价格={event.price}")
    
    # 立即响应
    if event.trade_type == TradeType.BUY:
        self.execute_sell_logic()

def on_order_canceled_event(self, event):
    """订单取消事件"""
    self.logger().warning(f"订单已取消: {event.order_id}")
```

### 4. 日志记录

```python
self.logger().info("信息级别")
self.logger().warning("警告级别")
self.logger().error("错误级别")
self.logger().debug("调试级别")
```

## 测试策略

### 单元测试

```python
import unittest
from hummingbot.test.isolated_asyncio_wrapper_test_case import IsolatedAsyncioTestCase


class TestMyCustomStrategy(IsolatedAsyncioTestCase):
    
    async def asyncSetUp(self):
        self.config = MyCustomStrategyConfig()
        # 初始化模拟连接器
        self.connectors = {}
    
    async def test_control_task(self):
        controller = MyCustomController(MyCustomControllerConfig())
        # 测试逻辑
        await controller.control_task()
```

### 回测

使用 Hummingbot 内置的回测功能：

```bash
hummingbot -c my_custom_strategy.yml --backtest
```

## 常见错误排查

### 问题 1：订单无法执行
- **原因**：交易对不正确或缺少流动性
- **解决**：检查交易对字符串格式（如 "BTC-USDT" vs "BTCUSDT"）

### 问题 2：控制器不执行
- **原因**：K线数据不足或数据源配置错误  - **解决**：增加 `candles_max_records`，检查 `candles_connector`

### 问题 3：API 速率限制
- **原因**：请求频率过高
- **解决**：增加 `update_interval`，使用 AsyncThrottler

## 性能优化建议

1. **批量操作**：合并多个 API 调用
2. **缓存数据**：避免重复计算
3. **异步处理**：充分利用 asyncio
4. **堆内存管理**：及时清理过期数据

## 下一步

- 了解[执行器系统](../执行器/执行器系统.md)
- 学习[控制器开发](../控制器/控制器系统.md)
- 查看[部署指南](../部署运维/部署指南.md)
- 浏览 `scripts/` 目录中的示例代码
