# Hummingbot 部署与运维指南

## 部署方案对比

| 方案 | 难度 | 性能 | 可靠性 | 适用场景 |
|------|------|------|--------|----------|
| **Docker** | 低 | 高 | 高 | 生产环境、云服务 |
| **本地源码** | 中 | 高 | 中 | 开发、测试、高度定制 |
| **云服务器** | 中 | 中 | 高 | 长期 24/7 运行 |
| **Kubernetes** | 高 | 高 | 很高 | 大规模部署、企业 |

## 部署方案详解

### 方案一：Docker 部署（推荐）

#### 优点
- ✅ 开箱即用
- ✅ 环境隔离
- ✅ 易于扩展
- ✅ 支持云平台

#### Docker 安装与配置

##### 1. 安装 Docker

**Ubuntu/Debian**：
```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 加入 docker 用户组（避免每次都用 sudo）
sudo usermod -aG docker $USER
newgrp docker
```

**macOS**：
```bash
brew install docker --cask
# 或从官网下载 Docker Desktop
```

**Windows**：
- 下载 [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop)

##### 2. 安装 Docker Compose

```bash
# 最新版本（Linux）
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证
docker-compose --version
```

##### 3. 启动 Hummingbot

```bash
# 克隆仓库
git clone https://github.com/hummingbot/hummingbot.git
cd hummingbot

# 使用 Makefile 方便命令
make setup      # 构建镜像
make deploy     # 启动容器
make start      # 进入容器

# 或手动使用 docker-compose
docker-compose up -d  # 后台启动
docker attach hummingbot  # 进入容器
```

#### Docker 常用操作

```bash
# 查看容器状态
docker ps -a

# 查看容器日志
docker logs hummingbot
docker logs -f hummingbot  # 实时日志

# 进入容器
docker exec -it hummingbot bash

# 停止容器
docker stop hummingbot

# 重启容器
docker restart hummingbot

# 删除容器和镜像
docker rm hummingbot
docker rmi hummingbot
```

#### 数据持久化配置

修改 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  hummingbot:
    image: hummingbot/hummingbot:latest
    container_name: hummingbot
    volumes:
      - ./conf:/root/hummingbot/conf         # 配置文件
      - ./logs:/root/hummingbot/logs         # 日志文件
      - ./data:/root/hummingbot/data         # 数据文件
      - /etc/localtime:/etc/localtime:ro     # 同步时间
    environment:
      - HUMMINGBOT_AWARE_TIMESTAMP=1
    stdin_open: true
    tty: true
    restart: unless-stopped
```

### 方案二：本地源码部署

#### 系统要求

- Python 3.8+
- 4GB+ RAM
- 10GB+ 磁盘空间
- C++ 编译工具

#### 安装步骤

##### 1. 准备开发环境

```bash
# 安装系统依赖（Ubuntu/Debian）
sudo apt-get update
sudo apt-get install -y \
    build-essential \
    git \
    python3-dev \
    python3-venv \
    libffi-dev \
    libssl-dev

# 安装 Conda（推荐）
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh
```

##### 2. 创建虚拟环境

```bash
# 使用 conda
conda create -n hummingbot python=3.10
conda activate hummingbot

# 或使用 venv
python3 -m venv hummingbot_env
source hummingbot_env/bin/activate  # Linux/macOS
# hummingbot_env\Scripts\activate  # Windows
```

##### 3. 克隆并安装

```bash
git clone https://github.com/hummingbot/hummingbot.git
cd hummingbot

# 安装依赖
pip install -e .

# 编译 Cython 扩展
pip install -e . --no-build-isolation
```

##### 4. 验证安装

```bash
hummingbot -v  # 显示版本
hummingbot     # 启动应用
```

### 方案三：云服务器部署（24/7 运行）

#### 推荐云平台

| 平台 | 优点 | 缺点 |
|------|------|------|
| **AWS** | 功能强大、稳定 | 费用较高 |
| **Google Cloud** | 性能好、文档完善 | 初学者配置复杂 |
| **Azure** | 企业级、可靠 | 复杂、费用高 |
| **DigitalOcean** | 简单、便宜 | 功能有限 |
| **Linode** | 成本低、稳定 | 功能基础 |

#### DigitalOcean 部署示例

##### 1. 创建 Droplet

```bash
# 选择配置
- Ubuntu 20.04 LTS
- 2GB RAM, 50GB SSD（推荐最低配置）
- 新加坡或相近地区（降低网络延迟）
```

##### 2. 初始化服务器

```bash
# SSH 连接到服务器
ssh root@your_server_ip

# 更新系统
apt-get update && apt-get upgrade -y

# 创建普通用户（避免用 root）
adduser hummingbot
usermod -aG sudo hummingbot

# 切换用户
su - hummingbot
```

##### 3. 安装 Hummingbot

```bash
# 安装 Docker（推荐）
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker hummingbot

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 克隆仓库
git clone https://github.com/hummingbot/hummingbot.git
cd hummingbot

# 启动
make setup
make deploy
```

##### 4. 后台运行与监控

```bash
# 使用 systemd 服务管理

# 创建服务文件
sudo nano /etc/systemd/system/hummingbot.service
```

```ini
[Unit]
Description=Hummingbot Trading Bot
After=network.target docker.service
Requires=docker.service

[Service]
Type=simple
User=hummingbot
WorkingDirectory=/home/hummingbot/hummingbot
ExecStart=/usr/local/bin/docker-compose up
ExecStop=/usr/local/bin/docker-compose down
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 启用并启动
sudo systemctl daemon-reload
sudo systemctl enable hummingbot
sudo systemctl start hummingbot

# 查看状态
sudo systemctl status hummingbot

# 查看日志
sudo journalctl -u hummingbot -f
```

### 方案四：Kubernetes 部署（企业级）

#### 创建 Kubernetes 部署文件

```yaml
# hummingbot-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hummingbot
  labels:
    app: hummingbot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hummingbot
  template:
    metadata:
      labels:
        app: hummingbot
    spec:
      containers:
      - name: hummingbot
        image: hummingbot/hummingbot:latest
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        volumeMounts:
        - name: conf
          mountPath: /root/hummingbot/conf
        - name: logs
          mountPath: /root/hummingbot/logs
        - name: data
          mountPath: /root/hummingbot/data
      volumes:
      - name: conf
        persistentVolumeClaim:
          claimName: hummingbot-conf-pvc
      - name: logs
        persistentVolumeClaim:
          claimName: hummingbot-logs-pvc
      - name: data
        persistentVolumeClaim:
          claimName: hummingbot-data-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: hummingbot-conf-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: hummingbot-logs-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: hummingbot-data-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

```bash
# 部署
kubectl apply -f hummingbot-deployment.yaml

# 查看状态
kubectl get pods
kubectl logs -f deployment/hummingbot
```

## 运维最佳实践

### 1. 日志管理

```bash
# 日志位置
/root/hummingbot/logs/

# 关键日志文件
trading_bot.log        # 主日志
bot_config.log         # 配置日志
connector_*.log        # 特定交易所日志

# 查看日志
tail -f logs/trading_bot.log

# 压缩日志（定期清理）
gzip logs/*.log.*
```

### 2. 备份策略

```bash
# 定期备份配置和数据
tar -czf hummingbot_backup_$(date +%Y%m%d).tar.gz conf/ logs/ data/

# 自动备份脚本（cron）
# 编辑 crontab
crontab -e

# 添加每天 02:00 备份
0 2 * * * cd /home/hummingbot/hummingbot && tar -czf backups/backup_$(date +\%Y\%m\%d).tar.gz conf/ logs/ data/
```

### 3. 性能监控

```bash
# 监控系统资源
docker stats hummingbot

# 内存占用
docker exec hummingbot ps aux | grep python

# 磁盘使用
du -sh /root/hummingbot/*

# 网络连接
docker exec hummingbot netstat -an | grep ESTABLISHED
```

### 4. 故障排查

#### 问题：无法连接到交易所

```bash
# 检查网络连接
ping api.binance.com

# 检查 API 密钥
# 查看日志
docker logs hummingbot | grep -i error

# 重启连接器
# 在 CLI 中执行: import_privatekey <exchange> <key>
```

#### 问题：内存泄漏

```bash
# 监控内存增长
watch -n 5 'docker stats --no-stream hummingbot'

# 定期重启
docker restart hummingbot

# 或设置自动重启
systemctl restart hummingbot

# 定期清理日志
find logs/ -type f -mtime +30 -delete
```

#### 问题：订单无法执行

```bash
# 检查账户余额
# 检查交易对是否存在
# 查看具体错误日志
docker logs hummingbot | grep -i order

# 测试 API 连接
# 在策略中添加测试代码
```

### 5. 安全加固

```bash
# 1. 修改 SSH 端口
sudo nano /etc/ssh/sshd_config
# Port 22 -> Port 2222

# 2. 禁用密码登录（使用密钥）
PubkeyAuthentication yes
PasswordAuthentication no

sudo systemctl restart sshd

# 3. 防火墙配置
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 2222/tcp  # SSH
sudo ufw allow 8080/tcp  # Hummingbot Web UI（如果启用）

# 4. 定期更新
sudo apt-get update && sudo apt-get upgrade -y

# 5. 加密 API 密钥存储
# Hummingbot 会自动加密存储在 conf/ 目录
```

### 6. 性能优化

#### 内存优化

```bash
# 减少日志输出
# 在 conf/logging.yml 中调整日志级别
- '{"name": "hummingbot", "level": "WARNING"}'

# 清理旧日志
find logs/ -type f -name "*.log*" -mtime +7 -delete
```

#### CPU 优化

```bash
# 增加更新间隔
# 在配置中设置 update_interval > 1

# 减少 K 线历史长度
max_records: 500  # 而不是 1000+
```

## 监控与告警

### 集成第三方监控

#### Prometheus + Grafana

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'hummingbot'
    static_configs:
      - targets: ['localhost:9090']
```

#### Datadog（Hummingbot 官方支持）

```bash
# 启用 Datadog 上报
export DD_AGENT_HOST=127.0.0.1
export DD_STATSD_PORT=8125

# 在策略中记录自定义指标
from hummingbot.core.utils.eip import is_eip1271_signature_support

# 利用内置 metrics
self.logger().info(f"PnL: {pnl}")
```

## 更新与升级

```bash
# 更新 Docker 镜像
docker pull hummingbot/hummingbot:latest

# 备份当前配置
cp -r conf conf_backup_$(date +%Y%m%d)

# 重建容器
docker-compose down
docker-compose up -d
```

## 故障恢复清单

- [ ] 停止运行中的 bot
- [ ] 检查日志确定问题
- [ ] 备份当前配置和日志
- [ ] 尝试重启容器
- [ ] 验证 API 连接
- [ ] 检查系统资源（CPU、内存、磁盘）
- [ ] 若问题持续，恢原至上一次备份
- [ ] 联系 Discord 社区寻求帮助

## 下一步

- 查看[最佳实践](../快速开始/安装与启动.md)
- 阅读[策略开发指南](../策略开发/新策略开发指南.md)
- 参与 [Hummingbot 社区](https://discord.gg/hummingbot)
